# Delete this file if using GitHub actions for CI.
dist: focal

services:
  - docker

language: php

php: '8.0'

before_install:
  - sudo apt update && sudo apt install -y docker-buildx-plugin
  - nvm install
  - nvm use
  - mkdir -p uploads

install:
  #- echo "$DOCKER_PASSWORD" | docker login ghcr.io -u "$DOCKER_USERNAME" --password-stdin
  #- docker-compose pull wordpress mkcert
  - docker buildx bake --push --set '*.platform=linux/amd64,linux/arm64'
  - npm install

script:
  - npm run lint
  - npm run test

deploy:

  # Deploy to production.
  - provider: script
    script:
      - npm run deploy-production
    skip_cleanup: true
    on:
      branch: master
      condition: -z $SKIP_DEPLOY

  # Deploy to staging.
  - provider: script
    script:
      - npm run deploy-staging
    skip_cleanup: true
    on:
      branch: develop
      condition: -z $SKIP_DEPLOY

# Travis must run on brances that need to be deployed.
branches:
  only:
  - master
  - develop

cache:
  npm: true
  directories:
    - $HOME/.composer/cache

notifications:
  email: false
