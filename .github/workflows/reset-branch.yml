name: Reset Branch

on:
  workflow_dispatch:
    inputs:
      from_branch:
        description: 'Source branch to reset FROM'
        required: true
        type: choice
        options:
          - main
          - production
      to_branch:
        description: 'Target branch to reset TO'
        required: true
        type: choice
        options:
          - develop
      confirm_reset:
        description: 'Type "RESET" to confirm this destructive operation'
        required: true
        type: string

env:
  # Git Configuration
  GIT_USER_NAME: ${{ vars.GIT_USER_NAME || 'XWP Deploy Bot' }}
  GIT_USER_EMAIL: ${{ vars.GIT_USER_EMAIL || 'technology@xwp.co' }}
  # Slack Configuration
  SLACK_CHANNEL: ${{ vars.SLACK_CHANNEL }}
  SLACK_WEBHOOK_URL: ${{ secrets.SLACK_WEBHOOK_URL }}

jobs:
  reset-branch:
    name: Reset Branch
    runs-on: ubuntu-22.04
    steps:
      - name: Validate confirmation
        run: |
          if [[ "${{ inputs.confirm_reset }}" != "RESET" ]]; then
            echo "‚ùå Confirmation failed. You must type 'RESET' exactly to proceed."
            echo "You entered: '${{ inputs.confirm_reset }}'"
            exit 1
          fi
          echo "‚úÖ Confirmation validated"

      - name: Validate branch combination
        run: |
          FROM="${{ inputs.from_branch }}"
          TO="${{ inputs.to_branch }}"

          echo "üîç Validating branch reset: ${FROM} ‚Üí ${TO}"

          # Validate allowed combinations
          if [[ "${FROM}" == "${TO}" ]]; then
            echo "‚ùå Source and target branches cannot be the same"
            exit 1
          fi

          # Log the operation
          echo "‚úÖ Valid branch reset operation: ${FROM} ‚Üí ${TO}"

      - uses: actions/checkout@v6
        with:
          fetch-depth: 0 # Fetch all history for all branches
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Setup Git credentials
        run: |
          git config --global user.name "${{ env.GIT_USER_NAME }}"
          git config --global user.email "${{ env.GIT_USER_EMAIL }}"

      - name: Notify Slack - Reset started
        if: env.SLACK_CHANNEL != '' && env.SLACK_WEBHOOK_URL != ''
        uses: 8398a7/action-slack@v3
        with:
          status: custom
          custom_payload: |
            {
              "channel": "${{ env.SLACK_CHANNEL }}",
              "attachments": [{
                "color": "#ff9900",
                "pretext": ":warning: *Branch Reset In Progress*",
                "title": "üîÑ Branch Reset Started",
                "fields": [
                  {
                    "title": "Operation",
                    "value": "Reset `${{ inputs.to_branch }}` to match `${{ inputs.from_branch }}`",
                    "short": false
                  },
                  {
                    "title": "Source Branch",
                    "value": "`${{ inputs.from_branch }}`",
                    "short": true
                  },
                  {
                    "title": "Target Branch",
                    "value": "`${{ inputs.to_branch }}`",
                    "short": true
                  },
                  {
                    "title": "Initiated by",
                    "value": "${{ github.actor }}",
                    "short": true
                  },
                  {
                    "title": "Warning",
                    "value": "‚ö†Ô∏è This is a destructive operation that will overwrite the target branch",
                    "short": false
                  }
                ],
                "actions": [
                  {
                    "type": "button",
                    "text": "View Run",
                    "url": "${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}"
                  }
                ]
              }]
            }

      - name: Reset target branch
        run: |
          FROM_BRANCH="${{ inputs.from_branch }}"
          TO_BRANCH="${{ inputs.to_branch }}"

          echo "üîÑ Resetting ${TO_BRANCH} to match ${FROM_BRANCH}..."

          # Fetch all refs to ensure we have latest
          git fetch origin

          # Validate that source branch exists
          if ! git show-ref --verify --quiet refs/remotes/origin/${FROM_BRANCH}; then
            echo "‚ùå Source branch '${FROM_BRANCH}' does not exist"
            exit 1
          fi

          # Validate that target branch exists
          if ! git show-ref --verify --quiet refs/remotes/origin/${TO_BRANCH}; then
            echo "‚ùå Target branch '${TO_BRANCH}' does not exist"
            exit 1
          fi

          # Get commit SHAs for logging
          FROM_SHA=$(git rev-parse origin/${FROM_BRANCH})
          TO_SHA_BEFORE=$(git rev-parse origin/${TO_BRANCH})

          echo "üìç Source (${FROM_BRANCH}): ${FROM_SHA:0:8}"
          echo "üìç Target before (${TO_BRANCH}): ${TO_SHA_BEFORE:0:8}"

          # Check if branches are already identical
          if [[ "${FROM_SHA}" == "${TO_SHA_BEFORE}" ]]; then
            echo "‚ÑπÔ∏è Branches are already identical - no reset needed"
            echo "‚úÖ Both branches point to: ${FROM_SHA:0:8}"
          else
            echo "üîÑ Branches differ - proceeding with reset"
          fi

          # Checkout target branch
          git checkout -B ${TO_BRANCH} origin/${FROM_BRANCH}

          # Force push to update remote
          git push --force-with-lease origin ${TO_BRANCH}

          # Get final SHA
          TO_SHA_AFTER=$(git rev-parse HEAD)
          echo "üìç Target after (${TO_BRANCH}): ${TO_SHA_AFTER:0:8}"

          # Set outputs for Slack notification
          echo "from-branch=${FROM_BRANCH}" >> $GITHUB_OUTPUT
          echo "to-branch=${TO_BRANCH}" >> $GITHUB_OUTPUT
          echo "from-sha=${FROM_SHA:0:8}" >> $GITHUB_OUTPUT
          echo "to-sha-before=${TO_SHA_BEFORE:0:8}" >> $GITHUB_OUTPUT
          echo "to-sha-after=${TO_SHA_AFTER:0:8}" >> $GITHUB_OUTPUT
        id: reset

      - name: Trigger deployment via repository dispatch
        uses: actions/github-script@v8
        continue-on-error: true
        id: dispatch
        with:
          script: |
            try {
              console.log('üöÄ Triggering deployment via repository dispatch...');

              await github.rest.repos.createDispatchEvent({
                owner: context.repo.owner,
                repo: context.repo.repo,
                event_type: 'branch-reset-deploy',
                client_payload: {
                  branch: '${{ inputs.to_branch }}',
                  from_branch: '${{ inputs.from_branch }}',
                  reset_by: '${{ github.actor }}',
                  reset_sha: '${{ steps.reset.outputs.to-sha-after }}'
                }
              });

              console.log('‚úÖ Repository dispatch event sent - deployment should start shortly');
              core.setOutput('success', 'true');
              return true;
            } catch (error) {
              console.error('‚ùå Failed to trigger deployment:', error.message);
              console.log('‚ö†Ô∏è Branch reset completed successfully, but automatic deployment failed');
              console.log('üí° You can manually trigger deployment from Actions tab');
              core.setOutput('success', 'false');
              return false;
            }

      - name: Notify Slack - Reset success
        if: success() && env.SLACK_CHANNEL != '' && env.SLACK_WEBHOOK_URL != ''
        uses: 8398a7/action-slack@v3
        with:
          status: custom
          custom_payload: |
            {
              "channel": "${{ env.SLACK_CHANNEL }}",
              "attachments": [{
                "color": "#36a64f",
                "pretext": ":white_check_mark: *Branch Reset Completed Successfully*",
                "title": "‚úÖ Branch Reset Successful",
                "fields": [
                  {
                    "title": "Operation",
                    "value": "Reset `${{ inputs.to_branch }}` to match `${{ inputs.from_branch }}`",
                    "short": false
                  },
                  {
                    "title": "Source Branch",
                    "value": "`${{ inputs.from_branch }}` (`${{ steps.reset.outputs.from-sha }}`)",
                    "short": true
                  },
                  {
                    "title": "Target Branch",
                    "value": "`${{ inputs.to_branch }}` (`${{ steps.reset.outputs.to-sha-after }}`)",
                    "short": true
                  },
                  {
                    "title": "Previous Target",
                    "value": "`${{ steps.reset.outputs.to-sha-before }}`",
                    "short": true
                  },
                  {
                    "title": "Initiated by",
                    "value": "${{ github.actor }}",
                    "short": true
                  },
                  {
                    "title": "Next Step",
                    "value": "${{ steps.dispatch.outputs.success == 'true' && 'The Test and Deploy workflow will automatically trigger for the updated' || 'Automatic deployment failed. You can manually trigger deployment from the Actions tab for the updated' }} `${{ inputs.to_branch }}` branch",
                    "short": false
                  }
                ],
                "actions": [
                  {
                    "type": "button",
                    "text": "View Branch",
                    "url": "${{ github.server_url }}/${{ github.repository }}/tree/${{ inputs.to_branch }}",
                    "style": "primary"
                  },
                  {
                    "type": "button",
                    "text": "View Actions",
                    "url": "${{ github.server_url }}/${{ github.repository }}/actions"
                  }
                ]
              }]
            }

      - name: Notify Slack - Reset failed
        if: failure() && env.SLACK_CHANNEL != '' && env.SLACK_WEBHOOK_URL != ''
        uses: 8398a7/action-slack@v3
        with:
          status: custom
          custom_payload: |
            {
              "channel": "${{ env.SLACK_CHANNEL }}",
              "attachments": [{
                "color": "#ff0000",
                "pretext": ":x: *Branch Reset Failed - Immediate Attention Required*",
                "title": "‚ùå Branch Reset Failed",
                "fields": [
                  {
                    "title": "Operation",
                    "value": "Reset `${{ inputs.to_branch }}` to match `${{ inputs.from_branch }}`",
                    "short": false
                  },
                  {
                    "title": "Source Branch",
                    "value": "`${{ inputs.from_branch }}`",
                    "short": true
                  },
                  {
                    "title": "Target Branch",
                    "value": "`${{ inputs.to_branch }}`",
                    "short": true
                  },
                  {
                    "title": "Initiated by",
                    "value": "${{ github.actor }}",
                    "short": true
                  },
                  {
                    "title": "Status",
                    "value": "‚ö†Ô∏è Branch may be in an inconsistent state - manual intervention may be required",
                    "short": false
                  }
                ],
                "actions": [
                  {
                    "type": "button",
                    "text": "View Logs",
                    "url": "${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}",
                    "style": "danger"
                  }
                ]
              }]
            }
