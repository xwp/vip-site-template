name: Release Branch Cleanup

on:
  pull_request:
    types: [closed]
    branches: [production]

env:
  # Slack Configuration
  SLACK_CHANNEL: ${{ vars.SLACK_CHANNEL }}
  SLACK_WEBHOOK_URL: ${{ secrets.SLACK_WEBHOOK_URL }}
  # Git Configuration
  GIT_USER_NAME: ${{ vars.GIT_USER_NAME || 'XWP Deploy Bot' }}
  GIT_USER_EMAIL: ${{ vars.GIT_USER_EMAIL || 'technology@xwp.co' }}

jobs:
  cleanup-release:
    name: Cleanup Release Branch
    runs-on: ubuntu-22.04
    # Only run if PR was merged (not just closed)
    if: github.event.pull_request.merged == true
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          token: ${{ secrets.GITHUB_TOKEN }} # Do not move to a variable

      - name: Setup Git
        run: |
          git config user.name "${{ env.GIT_USER_NAME }}"
          git config user.email "${{ env.GIT_USER_EMAIL }}"

      - name: Check if release branch exists
        id: check-branch
        run: |
          if git show-ref --verify --quiet refs/remotes/origin/release; then
            echo "exists=true" >> $GITHUB_OUTPUT
            echo "Release branch found - will proceed with cleanup"
          else
            echo "exists=false" >> $GITHUB_OUTPUT
            echo "Release branch not found - may have been auto-deleted by GitHub"
          fi

      - name: Get release information
        id: release-info
        if: steps.check-branch.outputs.exists == 'true'
        run: |
          # Get the release branch commit info
          RELEASE_SHA=$(git rev-parse origin/release)
          RELEASE_COMMIT_MSG=$(git log -1 --pretty="%s" origin/release)
          PRODUCTION_SHA=$(git rev-parse origin/production)

          echo "release_sha=${RELEASE_SHA}" >> $GITHUB_OUTPUT
          echo "release_commit_msg=${RELEASE_COMMIT_MSG}" >> $GITHUB_OUTPUT
          echo "production_sha=${PRODUCTION_SHA}" >> $GITHUB_OUTPUT

      - name: Get release version from existing draft
        id: create-tag
        uses: actions/github-script@v7
        with:
          script: |
            try {
              // Find existing draft release created by create-release-branch workflow
              const { data: releases } = await github.rest.repos.listReleases({
                owner: context.repo.owner,
                repo: context.repo.repo
              });

              const draftRelease = releases.find(release => release.draft);

              if (draftRelease && draftRelease.tag_name.startsWith('release-')) {
                console.log(`Found existing draft release: ${draftRelease.tag_name}`);
                core.setOutput('version', draftRelease.tag_name);
                return draftRelease.tag_name;
              } else {
                // Fallback to timestamp if no draft found
                const version = `release-${new Date().toISOString().replace(/[-T:.]/g, '').slice(0, 15).replace(/(\d{8})(\d{6})/, '$1-$2')}`;
                console.log(`No draft release found, generating fallback version: ${version}`);
                core.setOutput('version', version);
                return version;
              }
            } catch (error) {
              // Fallback to timestamp if API fails
              const version = `release-${new Date().toISOString().replace(/[-T:.]/g, '').slice(0, 15).replace(/(\d{8})(\d{6})/, '$1-$2')}`;
              console.log(`Error finding draft release, using fallback: ${version}`);
              core.setOutput('version', version);
              return version;
            }

      - name: Create release tag on production
        run: |
          VERSION="${{ steps.create-tag.outputs.version }}"
          echo "Using version: ${VERSION}"

          # Create and push the tag
          git fetch origin production
          git checkout production
          git pull origin production

          # Create annotated tag
          git tag -a "${VERSION}" -m "Production release ${VERSION}

          Release Notes:
          ${{ github.event.pull_request.body }}

          Merged PR: #${{ github.event.pull_request.number }}
          Merged by: ${{ github.event.pull_request.merged_by.login }}
          Release SHA: ${{ steps.release-info.outputs.release_sha }}"

          git push origin "${VERSION}"

          echo "Created production tag: ${VERSION}"

      - name: Delete release branch
        if: steps.check-branch.outputs.exists == 'true'
        run: |
          echo "Deleting release branch..."

          # Delete the remote release branch
          git push origin --delete release

          echo "Release branch deleted successfully"

      - name: Update GitHub release
        id: update-release
        uses: actions/github-script@v7
        continue-on-error: true
        with:
          script: |
            const version = "${{ steps.create-tag.outputs.version }}";

            try {
              // Try to find existing draft release
              const { data: releases } = await github.rest.repos.listReleases({
                owner: context.repo.owner,
                repo: context.repo.repo
              });

              const draftRelease = releases.find(release =>
                release.draft && (release.tag_name === version || release.name.includes(version))
              );

              if (draftRelease) {
                // Update existing draft release
                await github.rest.repos.updateRelease({
                  owner: context.repo.owner,
                  repo: context.repo.repo,
                  release_id: draftRelease.id,
                  tag_name: version,
                  name: `Production Release ${version}`,
                  body: `## Production Release ${version}\n` +
                        `\n` +
                        `**Deployment Date:** ${new Date().toISOString().split('T')[0]}\n` +
                        `**Deployed by:** ${{ github.event.pull_request.merged_by.login }}\n` +
                        `**PR:** #${{ github.event.pull_request.number }}\n` +
                        `\n` +
                        `### Release Notes\n` +
                        `${{ github.event.pull_request.body }}\n` +
                        `\n` +
                        `### Links\n` +
                        `- [Merged PR](${{ github.event.pull_request.html_url }})\n` +
                        `- [Production Branch](${context.payload.repository.html_url}/tree/production)\n` +
                        `\n` +
                        `---\n` +
                        `*This release was finalized automatically by the ${{ env.GIT_USER_NAME }}*`,
                  draft: false,
                  prerelease: false
                });

                console.log(`Updated release: ${draftRelease.html_url}`);
                return draftRelease.html_url;
              } else {
                // Create new release
                const { data: newRelease } = await github.rest.repos.createRelease({
                  owner: context.repo.owner,
                  repo: context.repo.repo,
                  tag_name: version,
                  name: `Production Release ${version}`,
                  body: `## Production Release ${version}\n` +
                        `\n` +
                        `**Deployment Date:** ${new Date().toISOString().split('T')[0]}\n` +
                        `**Deployed by:** ${{ github.event.pull_request.merged_by.login }}\n` +
                        `**PR:** #${{ github.event.pull_request.number }}\n` +
                        `\n` +
                        `### Release Notes\n` +
                        `${{ github.event.pull_request.body }}\n` +
                        `\n` +
                        `### Links\n` +
                        `- [Merged PR](${{ github.event.pull_request.html_url }})\n` +
                        `- [Production Branch](${context.payload.repository.html_url}/tree/production)\n` +
                        `\n` +
                        `---\n` +
                        `*This release was created automatically by the ${{ env.GIT_USER_NAME }}*`,
                  draft: false,
                  prerelease: false
                });

                console.log(`Created new release: ${newRelease.html_url}`);
                return newRelease.html_url;
              }
            } catch (error) {
              console.log(`Could not update GitHub release: ${error.message}`);
              return null;
            }

      - name: Notify Slack - Success
        if: success() && env.SLACK_CHANNEL != '' && env.SLACK_WEBHOOK_URL != ''
        uses: 8398a7/action-slack@v3
        with:
          status: custom
          custom_payload: |
            {
              "channel": "${{ env.SLACK_CHANNEL }}",
              "attachments": [{
                "color": "#36a64f",
                "pretext": ":tada: *Production Release Successfully Deployed*",
                "title": "üéâ Production Release Completed & Cleaned Up",
                "fields": [
                  {
                    "title": "Version",
                    "value": "${{ steps.create-tag.outputs.version }}",
                    "short": true
                  },
                  {
                    "title": "Deployed by",
                    "value": "${{ github.event.pull_request.merged_by.login }} (${{ github.event.pull_request.merged_by.name || github.event.pull_request.merged_by.login }})",
                    "short": true
                  },
                  {
                    "title": "PR",
                    "value": "<${{ github.event.pull_request.html_url }}|#${{ github.event.pull_request.number }}>",
                    "short": true
                  },
                  {
                    "title": "Branch Cleanup",
                    "value": "${{ steps.check-branch.outputs.exists == 'true' && 'Release branch deleted' || 'Release branch was already deleted by GitHub' }}",
                    "short": true
                  },
                  {
                    "title": "Actions Completed",
                    "value": "\n‚Ä¢ Production deployment successful\n‚Ä¢ Release tag created: `${{ steps.create-tag.outputs.version }}`\n‚Ä¢ GitHub release published\n‚Ä¢ Release branch cleaned up",
                    "short": false
                  }
                ],
                "actions": [
                  {
                    "type": "button",
                    "text": "View Production",
                    "url": "${{ github.server_url }}/${{ github.repository }}/tree/production",
                    "style": "primary"
                  },
                  {
                    "type": "button",
                    "text": "View Release",
                    "url": "${{ steps.update-release.outputs.result }}"
                  },
                  {
                    "type": "button",
                    "text": "View Deployment",
                    "url": "${{ github.server_url }}/${{ github.repository }}/deployments"
                  }
                ],
                "footer": "ü§ñ ${{ env.GIT_USER_NAME }}"
              }]
            }

      - name: Notify Slack - Partial success
        if: failure() && steps.check-branch.outputs.exists == 'false' && env.SLACK_CHANNEL != '' && env.SLACK_WEBHOOK_URL != ''
        uses: 8398a7/action-slack@v3
        with:
          status: custom
          custom_payload: |
            {
              "channel": "${{ env.SLACK_CHANNEL }}",
              "attachments": [{
                "color": "#ffa500",
                "pretext": ":warning: *Production Release Deployed (Minor Cleanup Issue)*",
                "title": "‚ö†Ô∏è Production Release Completed (Cleanup Skipped)",
                "fields": [
                  {
                    "title": "Version",
                    "value": "${{ steps.create-tag.outputs.version }}",
                    "short": true
                  },
                  {
                    "title": "Deployed by",
                    "value": "${{ github.event.pull_request.merged_by.login }} (${{ github.event.pull_request.merged_by.name || github.event.pull_request.merged_by.login }})",
                    "short": true
                  },
                  {
                    "title": "Note",
                    "value": "Release branch was already deleted (likely by GitHub's auto-delete feature)",
                    "short": false
                  }
                ],
                "footer": "ü§ñ ${{ env.GIT_USER_NAME }}"
              }]
            }

      - name: Notify Slack - Failure
        if: failure() && steps.check-branch.outputs.exists == 'true' && env.SLACK_CHANNEL != '' && env.SLACK_WEBHOOK_URL != ''
        uses: 8398a7/action-slack@v3
        with:
          status: custom
          custom_payload: |
            {
              "channel": "${{ env.SLACK_CHANNEL }}",
              "attachments": [{
                "color": "#ff0000",
                "pretext": ":x: *Release Cleanup Failed - Manual Action Required*",
                "title": "‚ùå Release Cleanup Failed",
                "fields": [
                  {
                    "title": "PR",
                    "value": "<${{ github.event.pull_request.html_url }}|#${{ github.event.pull_request.number }}>",
                    "short": true
                  },
                  {
                    "title": "Deployed by",
                    "value": "${{ github.event.pull_request.merged_by.login }} (${{ github.event.pull_request.merged_by.name || github.event.pull_request.merged_by.login }})",
                    "short": true
                  },
                  {
                    "title": "Error",
                    "value": "Production deployment succeeded but cleanup failed. Check the <${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}|workflow logs> for details. Manual cleanup may be required.",
                    "short": false
                  }
                ],
                "actions": [
                  {
                    "type": "button",
                    "text": "View Logs",
                    "url": "${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}",
                    "style": "danger"
                  }
                ],
                "footer": "ü§ñ ${{ env.GIT_USER_NAME }}"
              }]
            }
