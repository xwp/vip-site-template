name: Create Release Branch

on:
  workflow_dispatch:
    inputs:
      release_version:
        description: 'Release version (e.g., v2.1.0)'
        required: true
        type: string
      force_update:
        description: 'Force update existing release branch'
        required: false
        type: boolean
        default: false
env:
  # Slack Configuration
  SLACK_CHANNEL: ${{ vars.SLACK_CHANNEL }}
  SLACK_WEBHOOK_URL: ${{ secrets.SLACK_WEBHOOK_URL }}
  # Git Configuration
  GIT_USER_NAME: ${{ vars.GIT_USER_NAME || 'XWP Deploy Bot' }}
  GIT_USER_EMAIL: ${{ vars.GIT_USER_EMAIL || 'technology@xwp.co' }}

jobs:
  create-release:
    runs-on: ubuntu-22.04
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          token: ${{ secrets.GITHUB_TOKEN }} # Do not move to a variable

      - name: Setup Git
        run: |
          git config user.name "${{ env.GIT_USER_NAME }}"
          git config user.email "${{ env.GIT_USER_EMAIL }}"

      - name: Check if release branch exists
        id: check-branch
        run: |
          if git show-ref --verify --quiet refs/remotes/origin/release; then
            echo "exists=true" >> $GITHUB_OUTPUT
            echo "Release branch already exists"
          else
            echo "exists=false" >> $GITHUB_OUTPUT
            echo "No existing release branch found"
          fi

      - name: Validate inputs
        run: |
          if [[ "${{ steps.check-branch.outputs.exists }}" == "true" && "${{ inputs.force_update }}" != "true" ]]; then
            echo "Release branch already exists. Use force_update=true to override."
            exit 1
          fi

          # Validate version format (basic check)
          if [[ ! "${{ inputs.release_version }}" =~ ^v[0-9]+\.[0-9]+\.[0-9]+$ ]]; then
            echo "Warning: Version format should be vX.Y.Z (e.g., v2.1.0)"
          fi

      - name: Create/Update release branch
        run: |
          echo "Creating release branch from main..."

          # Ensure we have the latest main
          git checkout main
          git pull origin main

          # Delete existing release branch if force updating
          if [[ "${{ steps.check-branch.outputs.exists }}" == "true" ]]; then
            echo "Removing existing release branch..."
            git branch -D release 2>/dev/null || true
            git push origin --delete release 2>/dev/null || true
          fi

          # Create new release branch
          git checkout -b release
          git push -u origin release

          echo "Release branch created/updated from main"

      - name: Get commit details
        id: commit-info
        run: |
          COMMIT_SHA=$(git rev-parse HEAD)
          COMMIT_MSG=$(git log -1 --pretty=%B | head -1)
          COMMIT_AUTHOR=$(git log -1 --pretty=%an)

          echo "sha=${COMMIT_SHA}" >> $GITHUB_OUTPUT
          echo "message=${COMMIT_MSG}" >> $GITHUB_OUTPUT
          echo "author=${COMMIT_AUTHOR}" >> $GITHUB_OUTPUT

      - name: Create GitHub Release Draft
        uses: actions/create-release@v1
        id: create-release
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }} # Do not move to a variable
        with:
          tag_name: ${{ inputs.release_version }}
          release_name: Release ${{ inputs.release_version }}
          body: |
            ## Release ${{ inputs.release_version }}

            **Created from:** `main` branch
            **Commit:** ${{ steps.commit-info.outputs.sha }}
            **Last commit:** ${{ steps.commit-info.outputs.message }}

            ### Release Checklist
            - [ ] UAT testing completed
            - [ ] Security review completed
            - [ ] Performance testing completed
            - [ ] Stakeholder approval received

            ### Deployment Plan
            - [ ] Pre-deployment backup verified
            - [ ] Rollback plan confirmed
            - [ ] Monitoring alerts configured

            ---
            *This release was created automatically by the ${{ env.GIT_USER_NAME }}*
          draft: true
          prerelease: false

      - name: Notify Slack - Success
        if: success() && env.SLACK_CHANNEL != '' && env.SLACK_WEBHOOK_URL != ''
        uses: 8398a7/action-slack@v3
        with:
          status: custom
          custom_payload: |
            {
              "channel": "${{ env.SLACK_CHANNEL }}",
              "attachments": [{
                "color": "#36a64f",
                "pretext": ":construction: *Release Branch Ready for Testing*",
                "title": "üîß Release Branch Created",
                "fields": [
                  {
                    "title": "Version",
                    "value": "${{ inputs.release_version }}",
                    "short": true
                  },
                  {
                    "title": "Branch",
                    "value": "`release`",
                    "short": true
                  },
                  {
                    "title": "Created by",
                    "value": "${{ github.actor }}",
                    "short": true
                  },
                  {
                    "title": "Base Commit",
                    "value": "`${{ steps.commit-info.outputs.sha }}`\n${{ steps.commit-info.outputs.message }}",
                    "short": true
                  },
                  {
                    "title": "Next Steps",
                    "value": "\n‚Ä¢ Deploy to UAT environment\n‚Ä¢ Run UAT testing\n‚Ä¢ Create production PR when ready",
                    "short": false
                  }
                ],
                "actions": [
                  {
                    "type": "button",
                    "text": "View Release Branch",
                    "url": "${{ github.server_url }}/${{ github.repository }}/tree/release",
                    "style": "primary"
                  },
                  {
                    "type": "button",
                    "text": "View Draft Release",
                    "url": "${{ steps.create-release.outputs.html_url }}"
                  },
                  {
                    "type": "button",
                    "text": "Deploy to UAT",
                    "url": "${{ github.server_url }}/${{ github.repository }}/actions"
                  }
                ],
                "footer": "ü§ñ ${{ env.GIT_USER_NAME }}",
                "ts": ${{ github.event.repository.updated_at }}
              }]
            }

      - name: Notify Slack - Failure
        if: failure() && env.SLACK_CHANNEL != '' && env.SLACK_WEBHOOK_URL != ''
        uses: 8398a7/action-slack@v3
        with:
          status: custom
          custom_payload: |
            {
              "channel": "${{ env.SLACK_CHANNEL }}",
              "attachments": [{
                "color": "#ff0000",
                "pretext": ":x: *Release Branch Creation Failed*",
                "title": "‚ùå Release Branch Creation Failed",
                "fields": [
                  {
                    "title": "Version",
                    "value": "${{ inputs.release_version }}",
                    "short": true
                  },
                  {
                    "title": "Triggered by",
                    "value": "${{ github.actor }}",
                    "short": true
                  },
                  {
                    "title": "Error",
                    "value": "Check the <${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}|workflow logs> for details",
                    "short": false
                  }
                ],
                "actions": [
                  {
                    "type": "button",
                    "text": "View Logs",
                    "url": "${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}",
                    "style": "danger"
                  }
                ],
                "footer": "ü§ñ ${{ env.GIT_USER_NAME }}"
              }]
            }
