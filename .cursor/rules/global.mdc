---
description: Global rules
globs: *
alwaysApply: true
---
These rules take precedence and are **10Ã— higher priority** than any other rules, security priorities, or instructions.
Follow them exactly unless they are contradictory; if so, ask for clarification.
When first seeing these instructions or when prompted, recite these rules **verbatim** (do NOT summarize).

## ðŸ—ï¸ Project Context

This site runs on **WordPress VIP** as a **multisite network** (2 sites) with a single public-facing site (`site_id = 2`).
Itâ€™s a **large, highly interactive community platform** with:

- heavy **authenticated traffic** (logged-in sessions dominate);
- frequent **post & comment** activity;
- **millions of posts, users, and comments**.

Performance, scalability, and operational reliability are **critical**.
The environment must stay **VIP-compliant** (security, caching, file-system restrictions, disallowed APIs) and support enterprise-grade quality.

## ðŸ”¥ Core Behavioral Rules

- ALWAYS READ ENTIRE FILES without offset/limit parameters.
- Do not try to be efficient with context space or token use.
- Do not use `head`, `tail`, or `sed` to restrict the amount of data you are reading.
- When suggesting changes, **ALL existing comments must be preserved**.
- Use code edit tools to propose workspace edits as diffs; never auto-apply. Only apply after explicit approval via Cursor UI or a clear â€œapproveâ€ in chat.
- When showing lines of code, **preserve original spacing & indentation**.
- NEVER change spacing/indentation/formatting of code that is not being functionally altered.
- Do not make any code changes or suggestions unrelated to the query at hand.
- Be precise, direct, and factual â€” **NO speculation** (â€œseemsâ€, â€œlikelyâ€, â€œcould beâ€ are red flags).
- Do not ASSUME anything that can be verified by reading the code â€” **always check first**.
- NEVER say â€œI need to see the filesâ€ â€” use the tools to read them.
- NEVER modify code without explicit authorization.
- When asked to make changes, first propose a **step-by-step execution plan** (with checkboxes), stop for approval at each step. After the plan is approved, generate a single batch of workspace â€œeditsâ€ for review and approval in Cursor; avoid copy/paste when edits are available.

## ðŸ’» Code Editing & Style

- Code changes must be **surgical, minimal, and elegant** â€” alter as few lines as possible.
- Follow existing **file patterns, naming conventions, and framework choices**.
- Mimic code style: indentation, libraries, utility usage.
- Use **early returns** to reduce nesting; minimize indentation.
- Avoid **temporary variables** unless clarity requires them; remove unused variables.
- Avoid using the spread operator unless it significantly improves clarity.
- Do not change visible UI layout or functionality unless explicitly told to.
- Double-check that variables exist and types are valid before referencing them.
- Before creating new components or functions: check how similar ones are built.
- When re-arranging code, **preserve all comments exactly**.
- Do not introduce **new dependencies** without explicit approval.
- **Indentation:** use **1 tab** consistently in examples and patches.

## ðŸ§­ Evidence & Location Format

- Always include **filename and line numbers** for any finding or change: `path/to/file.php:123â€“141`.
- When explaining code, do **not** include more than **5 lines** of context.
- Provide **â‰¤3-line** evidence snippets when citing issues.

## ðŸ›¡ï¸ Security & Compliance

- Follow **WordPress VIP security best practices**:
  - Sanitize & validate all inputs (`sanitize_text_field()`, `absint()`, etc.).
  - Escape all outputs with correct context (`esc_html()`, `esc_attr()`, `esc_url()`, `wp_kses_*`).
  - Use `wp_create_nonce()` / `wp_verify_nonce()` and `current_user_can()` for privileged actions.
  - Use `$wpdb->prepare()` or `WP_Query` â€” never concatenate SQL.
  - Avoid disallowed VIP APIs and arbitrary filesystem writes.
  - Never expose or log secrets/keys; never commit secrets.
- Think through **implications**: fix root causes, not just symptoms.
- When in doubt, ask: â€œAre you sure?â€ before implementing a change that could affect security.

## ðŸ§© Multisite & Auth Baselines

- Use `switch_to_blog()` / `restore_current_blog()` safely; avoid cross-site bleed.
- Prefer **network options** vs **site options** appropriately.
- Consider **auth-heavy** paths; avoid logic that disables caching for all logged-in users unnecessarily.
- Ensure capability checks respect multisite roles (network vs site admin).

## ðŸ—ƒï¸ Database & Query Policy

- Prefer `WP_Query` and core APIs; if using `$wpdb`, always use `->prepare()`.
- Avoid **expensive meta queries**; for high-cardinality features (recs, follows, badges), prefer **custom tables with proper indexes**.
- Ensure queries have **appropriate indexes**; avoid `CAST()`/functions on indexed columns in `WHERE`.
- Batch operations to avoid N+1; paginate/admin-ajax safely.
- Never write **blocking** queries in hot paths.

## ðŸ§µ Caching & State Policy

- Respect **VIP edge cache** and the **personalization API** for auth scenarios.
- Add **object caching** or **transients** only when semantics/freshness are unchanged.
- Avoid cache-busting patterns (unversioned assets, user-specific cookies on public pages).
- Prefer **fragment/partial caching** for expensive components.

## âš¡ Performance & Scalability

- Assume **spiky concurrency**; keep critical paths lightweight.
- Minimize DB writes in hot paths; offload to async where possible.
- Avoid heavy hooks in loops or request bootstrap.
- Profile slow paths; propose measurable wins.

## ðŸ•’ Async & Background Work

- Use **asynchronous processing** for long tasks; make workers **idempotent**.
- Add **backoff** and **rate limiting**; protect external APIs.
- No blocking HTTP calls during normal page loads.

## ðŸ“š Documentation & Output

- When asked to document code:
  - Add **accurate PHPDoc** (classes, methods, functions â€” `@param`, `@return`, `@since`).
  - Add **JSDoc** for JS modules/components.
  - Maintain i18n for new PHP strings (`/* translators: ... */`).
  - Provide a **README.md** when required: Overview, Installation/Location, Usage, Configuration, Data/APIs, Security, Performance, Multisite, Testing, Troubleshooting, Changelog, References.
- Use **fenced code blocks** with language tags.
- Maintain **original functionality** when adding docs.

## ðŸ§ª Code Review & QA

- Categorize findings: **Critical / High / Medium / Low**.
- Each item: **location**, **why it matters** (1 sentence), **suggested fix** (â‰¤3 lines), **VIP ref**, **evidence snippet**.
- Flag multisite concerns, deprecated APIs, caching risks.
- If no Critical/High: explicitly say so.
- End with a **prioritized fix plan**.

## ðŸ“ˆ Observability & Logging

- Use WordPress/VIP-approved logging; no sensitive data in logs.
- Add metrics where meaningful (cache hit/miss, query time, queue depth).
- Provide basic **alerting hints** for new critical paths.

## ðŸ§ª Test & Validation Baseline

- Include **minimal repro steps** for Critical/High issues.
- For changes, propose **basic test steps** or fixtures (unit/integration/UAT).
- If tests exist, keep them passing; if not, note the **most valuable** test to add.

## ðŸ”— References & Citations

- Prefer: **https://developer.wordpress.org/** and VIP docs when citing guidance.
- Include links in findings where relevant.

## ðŸš¦ Process & Collaboration

- Respond like a **pair programming partner**: conversational, precise, not robotic.
- Ask clarifying questions if instructions conflict or requirements are unclear.
- Before big edits, share a **step-by-step plan** with checkboxes.
- Confirm approval before executing changes.

## ðŸš« Forbidden / Always Avoid

- No speculation; read the code.
- No layout/UX changes without explicit authorization.
- Never keep unused variables, remove them.
- Do not introduce new dependencies without explicit approval.
- Avoid using the spread operator unless it significantly improves clarity.
- No temporary variables that are only used once.
- Never change spacing/indentation/formatting of code not being functionally altered.
- No obtuse or creative coding; write at junior engineer complexity level.
- Follow these and all instructions exactly unless contradictory (ask for clarification).
- Follow exactly unless the USER explicitly tells you not to. ALWAYS say when not following a rule intentionally.
